<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Objednávky jídelny</title>
<style>
  body{font-family:Inter,system-ui,Arial;background:#f4f6fb;margin:0;padding:20px;display:flex;justify-content:center}
  .wrap{width:100%;max-width:980px}
  h1{text-align:center;margin:6px 0 18px}
  .days{display:flex;gap:10px;margin-bottom:18px}
  .day-card{flex:1;background:#fff;border-radius:12px;padding:12px;text-align:center;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.06);transition:0.18s}
  .day-card:hover{transform:translateY(-4px)}
  .day-card.active{background:#2563eb;color:#fff;box-shadow:0 6px 16px rgba(0,0,0,0.12)}
  .card{background:#fff;border-radius:12px;padding:16px;margin-bottom:14px;box-shadow:0 2px 10px rgba(0,0,0,0.05)}
  label{display:block;margin-top:10px}
  select,input[type="number"],input[type="text"]{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-top:6px}
  .row{display:flex;gap:10px}
  .row > *{flex:1}
  button{margin-top:12px;padding:10px 14px;border-radius:10px;border:none;background:#2563eb;color:#fff;cursor:pointer}
  button.small{padding:6px 10px;border-radius:8px;font-size:14px}
  .order-item{display:flex;justify-content:space-between;align-items:center;background:#f7fbff;padding:10px;border-radius:8px;margin-top:8px}
  .order-item .meta{font-size:14px}
  .muted{color:#666;font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Jídelna — objednávky</h1>

  <div id="days" class="days"></div>

  <div id="menuCard" class="card" style="display:none">
    <h3 id="menuTitle">Jídelníček</h3>
    <div id="menuItems" class="muted"></div>

    <label>Typ menu:
      <select id="menuType">
        <option>Celé menu</option>
        <option>Poloviční menu</option>
        <option>Půl+Půl menu</option>
        <option>Hlavní jídlo</option>
        <option>Poloviční hlavní jídlo</option>
        <option>Polévka</option>
      </select>
    </label>

    <label id="mainChoiceLabel" style="display:none">Vyber hlavní jídlo:
      <select id="mainChoice">
        <option value="jidlo1">Jídlo 1</option>
        <option value="jidlo2">Jídlo 2</option>
      </select>
    </label>

    <div class="row">
      <label style="flex:0 0 160px">Počet porcí:
        <input id="portion" type="number" min="1" value="1">
      </label>
      <div style="flex:1"></div>
    </div>

    <button id="addToCart">Přidat do objednávky</button>
  </div>

  <div id="ordersCard" class="card">
    <h3>Finální objednávka</h3>

    <label>Jméno:
      <input id="custName" type="text" placeholder="Jméno (bude uloženo do prohlížeče)">
    </label>

    <label>Kontakt (email nebo telefon):
      <input id="custContact" type="text" placeholder="E-mail nebo telefon">
    </label>

    <label>Doručení:
      <select id="finalDelivery">
        <option value="Vyzvednu">Vyzvednu</option>
        <option value="Přivézt">Přivézt</option>
      </select>
    </label>

    <label id="addrLabel" style="display:none">Adresa pro doručení:
      <input id="custAddress" type="text" placeholder="Ulice, číslo, město">
    </label>

    <div id="orderList"></div>

    <p class="muted">Celkem: <strong id="total">0</strong> Kč</p>

    <button id="sendOrder">Odeslat objednávku</button>
  </div>
</div>

<script>
/* ---------- UPRAVIT: vlož svůj nasazený Web App URL (Apps Script) ---------- */
const APPS_SCRIPT_GET_URL = 'https://script.google.com/macros/s/AKfycbzizxN4Nq-2KBIUa6r5cOL66DpE2TI0o0js7RewcEJ0bcbXM_UTU-LFMZEFpOxDurJ-/exec';
const APPS_SCRIPT_POST_URL = 'https://script.google.com/macros/s/AKfycbzizxN4Nq-2KBIUa6r5cOL66DpE2TI0o0js7RewcEJ0bcbXM_UTU-LFMZEFpOxDurJ-/exec'; // <- po nasazení stejný jako GET nebo nový web app URL

let week = [];    // načtená data week: [{row:{date,dayName,polevka,jidlo1,jidlo2}}]
let ceny = {};    // map typMenu -> cena
let cart = [];    // seznam položek
let activeIndex = null;

/* --- načti data (menu + ceny) --- */
async function init() {
  try {
    const res = await fetch(APPS_SCRIPT_GET_URL);
    if (!res.ok) throw new Error('Chyba při načítání dat: ' + res.status);
    const data = await res.json();
    week = (data.week || []).filter((_,i)=>i<5); // Po–Pá
    (data.ceny || []).forEach(c => ceny[c.typMenu] = Number(c.cena) || 0);
    // fallback ceny (pokud nejsou v listu)
    if (!ceny['Polévka']) ceny['Polévka']=40;
    if (!ceny['Hlavní jídlo']) ceny['Hlavní jídlo']=135;
    if (!ceny['Poloviční menu']) ceny['Poloviční menu']=115;
    if (!ceny['Celé menu']) ceny['Celé menu']=155;
    if (!ceny['Poloviční hlavní jídlo']) ceny['Poloviční hlavní jídlo']=115;
    if (!ceny['Půl+Půl menu']) ceny['Půl+Půl menu']=155;

    renderDays();
    loadSavedCustomer();
  } catch (err) {
    console.error(err);
    alert('Chyba při načítání menu. Zkontroluj APPS_SCRIPT_GET_URL a deploy.');
  }
}

/* --- render karet dnů --- */
function renderDays(){
  const daysEl = document.getElementById('days');
  daysEl.innerHTML = '';
  week.forEach((w, i) => {
    const d = w.row;
    const dd = new Date(d.date);
    const ddFmt = `${String(dd.getDate()).padStart(2,'0')}.${String(dd.getMonth()+1).padStart(2,'0')}.`;
    const div = document.createElement('div');
    div.className = 'day-card';
    div.innerHTML = `<div>${d.dayName}</div><div class="muted">${ddFmt}</div>`;
    div.addEventListener('click', ()=> selectDay(i));
    daysEl.appendChild(div);
  });
}

/* --- vyber den --- */
function selectDay(idx){
  activeIndex = idx;
  document.querySelectorAll('.day-card').forEach((c,i)=>c.classList.toggle('active', i===idx));
  const d = week[idx].row;
  document.getElementById('menuCard').style.display = 'block';
  document.getElementById('menuTitle').textContent = `${d.dayName} — ${String(new Date(d.date).getDate()).padStart(2,'0')}.${String(new Date(d.date).getMonth()+1).padStart(2,'0')}.`;
  document.getElementById('menuItems').innerHTML = `<div><strong>Polévka:</strong> ${d.polevka||'–'}</div>
    <div><strong>Jídlo 1:</strong> ${d.jidlo1||'–'}</div>
    <div><strong>Jídlo 2:</strong> ${d.jidlo2||'–'}</div>`;
  // výchozí hodnoty
  document.getElementById('menuType').value = 'Celé menu';
  document.getElementById('mainChoiceLabel')?.style.display = 'block';
  document.getElementById('portion').value = 1;
  updateMainChoiceVisibility();
  updateTotal();
}

/* --- zobrazit volbu hlavního jídla jen pro vybrané typy --- */
document.getElementById('menuType').addEventListener('change', updateMainChoiceVisibility);
function updateMainChoiceVisibility(){
  const t = document.getElementById('menuType').value;
  const label = document.getElementById('mainChoiceLabel');
  if (['Celé menu','Poloviční menu','Hlavní jídlo','Poloviční hlavní jídlo'].includes(t)) {
    label.style.display = 'block';
  } else {
    label.style.display = 'none';
  }
}

/* --- přidat do košíku --- */
document.getElementById('addToCart').addEventListener('click', ()=>{
  if (activeIndex === null) return alert('Vyberte den nejprve.');
  const d = week[activeIndex].row;
  const type = document.getElementById('menuType').value;
  const mainChoice = document.getElementById('mainChoice').value; // 'jidlo1'|'jidlo2'
  const portions = parseInt(document.getElementById('portion').value,10) || 1;

  // které jídlo jména
  const jidlo1Name = d.jidlo1 || '';
  const jidlo2Name = d.jidlo2 || '';

  // price lookup dle typu
  const priceSingle = ceny[type] !== undefined ? ceny[type] : 0;
  const price = priceSingle * portions;

  // pokud Půl+Půl, automaticky obě jídla - mainChoice nepoužijeme
  cart.push({
    dayName: d.dayName,
    dateISO: d.date,
    type: type,
    mainChoice: (type === 'Půl+Půl menu') ? 'both' : mainChoice,
    jidlo1Name: jidlo1Name,
    jidlo2Name: jidlo2Name,
    portions: portions,
    priceSingle: priceSingle,
    priceTotal: price
  });

  renderCart();
});

/* --- render košíku --- */
function renderCart(){
  const list = document.getElementById('orderList');
  list.innerHTML = '';
  let total = 0;
  cart.forEach((it, idx) => {
    total += it.priceTotal;
    const div = document.createElement('div');
    div.className = 'order-item';
    const mainText = (it.mainChoice === 'both') ? `${it.jidlo1Name} + ${it.jidlo2Name}` : (it.mainChoice === 'jidlo1' ? it.jidlo1Name : it.jidlo2Name);
    div.innerHTML = `<div class="meta"><strong>${it.dayName}</strong> · ${it.type} · ${mainText ? mainText : ''} · x${it.portions}</div>`;
    const right = document.createElement('div');
    right.innerHTML = `<div class="muted">${it.priceTotal} Kč</div>`;
    const del = document.createElement('button');
    del.className = 'small';
    del.textContent = 'Smazat';
    del.addEventListener('click', ()=> { cart.splice(idx,1); renderCart(); });
    right.appendChild(del);
    div.appendChild(right);
    list.appendChild(div);
  });
  document.getElementById('total').textContent = total;
  updateTotal();
}

/* --- doručení pole zobrazení --- */
document.getElementById('finalDelivery').addEventListener('change', ()=>{
  const v = document.getElementById('finalDelivery').value;
  document.getElementById('addrLabel').style.display = (v === 'Přivézt') ? 'block' : 'none';
});

/* --- uložit a načíst jméno a kontakt do localStorage --- */
function loadSavedCustomer(){
  document.getElementById('custName').value = localStorage.getItem('custName') || '';
  document.getElementById('custContact').value = localStorage.getItem('custContact') || '';
}
document.getElementById('custName').addEventListener('input', (e)=> localStorage.setItem('custName', e.target.value));
document.getElementById('custContact').addEventListener('input', (e)=> localStorage.setItem('custContact', e.target.value));

/* --- odeslat objednávku na Apps Script --- */
document.getElementById('sendOrder').addEventListener('click', async ()=>{
  if (cart.length === 0) return alert('Košík je prázdný.');
  const name = document.getElementById('custName').value.trim();
  if (!name) return alert('Zadejte jméno.');
  const contact = document.getElementById('custContact').value.trim();
  const delivery = document.getElementById('finalDelivery').value;
  const address = (delivery === 'Přivézt') ? document.getElementById('custAddress').value.trim() : '';

  if (delivery === 'Přivézt' && !address) return alert('Zadejte adresu pro doručení.');

  // připrav payload pro server
  // doplníme textová jména jídel do objektu, aby server přesně věděl, co zapsat
  const ordersForServer = cart.map(it => {
    return {
      day: it.dayName,
      date: it.dateISO,
      type: it.type,
      mainChoice: it.mainChoice,
      jidlo1Name: it.jidlo1Name,
      jidlo2Name: it.jidlo2Name,
      portions: it.portions,
      price: it.priceTotal
    };
  });

  const payload = {
    name: name,
    contact: contact,
    delivery: delivery,
    address: address,
    orders: ordersForServer
  };

  try {
    const res = await fetch(APPS_SCRIPT_POST_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (data && data.result === 'ok') {
      alert('Objednávka odeslána — děkujeme!');
      cart = [];
      renderCart();
    } else {
      console.error('Server vrátil:', data);
      alert('Chyba při odesílání. Zkontroluj konzoli.');
    }
  } catch (err) {
    console.error(err);
    alert('Chyba při odesílání objednávky: ' + err.message);
  }
});

/* --- inicializace --- */
init();
</script>
</body>
</html>
