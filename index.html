<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Objednávky jídelny</title>
<style>
  :root{--maxw:900px;--accent:#2563eb}
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial; background:#f7f8fb; margin:0; padding:20px; display:flex; justify-content:center}
  .container{width:100%;max-width:var(--maxw);background:#fff;border-radius:12px;box-shadow:0 6px 30px rgba(20,20,50,0.06);padding:22px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px}
  h1{margin:0;font-size:20px}
  .user{font-size:14px;color:#444}
  .auth-buttons{display:flex;gap:8px;}
  button{cursor:pointer;padding:8px 12px;border-radius:8px;border:1px solid #e6e9ef;background:#fff}
  button.primary{background:var(--accent);color:#fff;border-color:transparent}
  .grid{display:grid;grid-template-columns:1fr 320px;gap:18px;margin-top:18px}
  .card{background:#fafbff;border-radius:10px;padding:14px;border:1px solid #f0f3ff}
  label{display:block;margin-top:10px;font-size:14px}
  input[type="text"], input[type="email"], select, textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #e2e6ef;margin-top:6px}
  .inline{display:flex;gap:8px;align-items:center}
  .small{font-size:13px;color:#666}
  .menu-item{padding:10px;border-radius:8px;background:#fff;border:1px solid #eef2ff;margin-top:8px}
  .hidden{display:none}
  footer{margin-top:14px;text-align:right}
  .msg{margin-top:12px;padding:10px;border-radius:8px}
  .msg.ok{background:#ecfdf5;color:#065f46;border:1px solid #bbf7d0}
  .msg.err{background:#ffefef;color:#611010;border:1px solid #ffd6d6}
  .loader{display:inline-block;width:14px;height:14px;border:2px solid #fff;border-radius:50%;border-right-color:transparent;animation:rot 1s linear infinite}
  @keyframes rot{to{transform:rotate(360deg)}}
  @media (max-width:880px){ .grid{grid-template-columns:1fr} .auth-buttons{flex-wrap:wrap} }
</style>
<!-- Firebase scripts -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Jídelna — objednávky</h1>
        <div class="small">Přihlášení + načtení jídelníčku z Google Sheets</div>
      </div>
      <div class="auth">
        <div class="user" id="userDisplay">Nejsi přihlášen</div>
        <div class="auth-buttons" id="authButtons">
          <button id="btnGoogle">Přihlásit Google</button>
          <button id="btnFacebook">Přihlásit Facebook</button>
          <button id="btnEmail">Přihlásit e-mail</button>
          <button id="btnSignOut" class="hidden">Odhlásit</button>
        </div>
      </div>
    </header>

    <div class="grid">
      <div>
        <div class="card">
          <h3>Jídelníček</h3>
          <div id="menuStatus" class="small">Načítám …</div>
          <div id="menuBox" class="hidden">
            <div class="menu-item"><strong>Polévka:</strong> <span id="menuPolevka"></span></div>
            <div class="menu-item"><strong>Hlavní 1:</strong> <span id="menuJidlo1"></span></div>
            <div class="menu-item"><strong>Hlavní 2:</strong> <span id="menuJidlo2"></span></div>
            <div class="small" style="margin-top:8px">Datum: <span id="menuDate"></span></div>
          </div>
        </div>

        <form id="orderForm" class="card" autocomplete="off" style="margin-top:14px">
          <h3>Objednávka</h3>

          <label>Jméno (z profilu nebo zadej):
            <input type="text" id="nameInput" placeholder="Jméno" required>
          </label>

          <label>E-mail:
            <input type="email" id="emailInput" placeholder="Email" required>
          </label>

          <div style="margin-top:10px">
            <label class="small">Vyber položky (pro typy menu níže jsou validace):</label>
            <div class="inline">
              <label><input type="checkbox" id="chkPolevka"> Polévka</label>
              <label style="margin-left:10px"><input type="checkbox" id="chkJidlo1"> Jídlo 1</label>
              <label style="margin-left:10px"><input type="checkbox" id="chkJidlo2"> Jídlo 2</label>
            </div>
          </div>

          <label>Typ menu:
            <select id="typSelect">
              <option value="Celé menu">Celé menu (polévka + 1 hlavní)</option>
              <option value="Poloviční menu">Poloviční menu (polévka + poloviční porce hlavního)</option>
              <option value="Půl + půl">Půl + půl (půlka Jídlo1 + půlka Jídlo2)</option>
              <option value="Jídlo">Jídlo (jen hlavní)</option>
              <option value="Polévka">Polévka (jen polévka)</option>
            </select>
          </label>

          <label id="whichHalfLabel" class="hidden">Které hlavní (pro Poloviční menu)?
            <select id="whichHalf">
              <option value="jidlo1">Jídlo 1 (poloviční)</option>
              <option value="jidlo2">Jídlo 2 (poloviční)</option>
            </select>
          </label>

          <label style="margin-top:10px">Doručení:
            <div class="inline" style="margin-top:6px">
              <label><input type="radio" name="delivery" value="Vyzvednu" checked> Vyzvednu</label>
              <label style="margin-left:10px"><input type="radio" name="delivery" value="Přivézt"> Přivézt</label>
            </div>
          </label>

          <label id="addressLabel" class="hidden">Adresa (povinné při Přivézt):
            <input type="text" id="addressInput" placeholder="Ulice, číslo, město">
          </label>

          <div style="margin-top:12px; display:flex; gap:8px; align-items:center">
            <button id="btnSubmit" class="primary" type="submit">Odeslat objednávku</button>
            <div id="status" class="small"></div>
          </div>

          <div id="resultMsg" class="msg hidden"></div>
        </form>
      </div>

      <div>
        <div class="card">
          <h3>Info / nápověda</h3>
          <ul style="margin:8px 0 0 18px;">
            <li>Pro přihlášení použij Google, Facebook nebo e-mail.</li>
            <li>Jídelníček je načítán z Google Sheets (Apps Script GET).</li>
            <li>Po odeslání se data uloží do Listu <code>Objednávky</code>.</li>
            <li>Pokud zvolíš <em>Přivézt</em>, adresa je povinná.</li>
          </ul>
        </div>

        <div class="card" style="margin-top:14px">
          <h3>Administrace (poznámky)</h3>
          <div class="small">
            <ol>
              <li>Nastav Apps Script (doGet pro menu, doPost pro objednávky) a publikuj jako Web App (Kdokoli).</li>
              <li>V Firebase Auth povol Google, Facebook, Email/Password.</li>
              <li>Pro Facebook: vytvoř FB App, vlož OAuth redirect URI do FB a client id atd. (viz Firebase docs).</li>
            </ol>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <div class="small">© Jídelna — jednoduché objednávky</div>
    </footer>
  </div>

<script>
/* ========== PLACEHOLDERS - nahraď svými hodnotami ========== */
const firebaseConfig = {
  apiKey: "AIzaSyDR9pvalNCGqW2JbWTLQtX_F5kHmnV41o8",
  authDomain: "mandala-b29bc.firebaseapp.com",
  projectId: "mandala-b29bc",
  storageBucket: "mandala-b29bc.firebasestorage.app",
  messagingSenderId: "470548601967",
  appId: "1:470548601967:web:52cd1477ab21ad2da6019a",
  measurementId: "G-EX4WRJNF2C"
};

const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxX8aAGEkt-uGzXnvWebktS7Qk_V-3EeLiN31e4ODwsTZmF1S2VpmEpE1sbzVP4OPso/exec"; // např. https://script.google.com/macros/s/..../exec
/* ========================================================== */

/* Inicializace Firebase (compat) */
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

/* UI elementy */
const userDisplay = document.getElementById('userDisplay');
const btnGoogle = document.getElementById('btnGoogle');
const btnFacebook = document.getElementById('btnFacebook');
const btnEmail = document.getElementById('btnEmail');
const btnSignOut = document.getElementById('btnSignOut');
const nameInput = document.getElementById('nameInput');
const emailInput = document.getElementById('emailInput');
const chkPolevka = document.getElementById('chkPolevka');
const chkJidlo1 = document.getElementById('chkJidlo1');
const chkJidlo2 = document.getElementById('chkJidlo2');
const typSelect = document.getElementById('typSelect');
const whichHalf = document.getElementById('whichHalf');
const whichHalfLabel = document.getElementById('whichHalfLabel');
const addressLabel = document.getElementById('addressLabel');
const addressInput = document.getElementById('addressInput');
const orderForm = document.getElementById('orderForm');
const status = document.getElementById('status');
const resultMsg = document.getElementById('resultMsg');
const menuStatus = document.getElementById('menuStatus');
const menuBox = document.getElementById('menuBox');
const menuPolevka = document.getElementById('menuPolevka');
const menuJidlo1 = document.getElementById('menuJidlo1');
const menuJidlo2 = document.getElementById('menuJidlo2');
const menuDate = document.getElementById('menuDate');
const btnSubmit = document.getElementById('btnSubmit');
const authButtons = document.getElementById('authButtons');

/* Auth providers */
const googleProvider = new firebase.auth.GoogleAuthProvider();
const fbProvider = new firebase.auth.FacebookAuthProvider();

/* ========== Auth handlers ========== */
btnGoogle.addEventListener('click', () => {
  status.innerHTML = '<span class="loader"></span> Přihlašuji...';
  auth.signInWithPopup(googleProvider).catch(err => {
    status.textContent = 'Chyba: ' + err.message;
  }).finally(()=> status.textContent = '');
});

btnFacebook.addEventListener('click', () => {
  status.innerHTML = '<span class="loader"></span> Přihlašuji...';
  auth.signInWithPopup(fbProvider).catch(err => {
    status.textContent = 'Chyba: ' + err.message;
  }).finally(()=> status.textContent = '');
});

btnEmail.addEventListener('click', () => {
  const email = prompt("Zadej e-mail:");
  if (!email) return;
  const password = prompt("Zadej heslo (pro nového uživatele bude vytvořen):");
  if (!password) return;
  status.innerHTML = '<span class="loader"></span> Přihlašuji...';
  auth.signInWithEmailAndPassword(email, password)
    .catch(err => {
      if (err.code === 'auth/user-not-found') {
        // vytvoření uživatele
        return auth.createUserWithEmailAndPassword(email, password);
      }
      throw err;
    })
    .catch(err => {
      status.textContent = 'Chyba: ' + err.message;
    })
    .finally(()=> status.textContent = '');
});

btnSignOut.addEventListener('click', () => auth.signOut());

auth.onAuthStateChanged(user => {
  if (user) {
    userDisplay.textContent = user.displayName ? `${user.displayName} (${user.email})` : user.email;
    btnSignOut.classList.remove('hidden');
    btnGoogle.classList.add('hidden');
    btnFacebook.classList.add('hidden');
    btnEmail.classList.add('hidden');
    // předvyplnit jméno a email
    if (user.displayName) nameInput.value = user.displayName;
    emailInput.value = user.email || '';
  } else {
    userDisplay.textContent = 'Nejsi přihlášen';
    btnSignOut.classList.add('hidden');
    btnGoogle.classList.remove('hidden');
    btnFacebook.classList.remove('hidden');
    btnEmail.classList.remove('hidden');
    // vyčistit předvyplnění
    // nameInput.value = '';
    // emailInput.value = '';
  }
});

/* ========== Načtení menu z Apps Script (GET) ========== */
async function loadMenu() {
  menuStatus.textContent = 'Načítám jídelníček…';
  try {
    const res = await fetch('https://script.google.com/macros/s/AKfycbxX8aAGEkt-uGzXnvWebktS7Qk_V-3EeLiN31e4ODwsTZmF1S2VpmEpE1sbzVP4OPso/exec');
    if (!res.ok) throw new Error('Chyba síťového požadavku');
    const data = await res.json();
    if (data.error) {
      menuStatus.textContent = 'Menu nenalezeno pro dnešek.';
      return;
    }
    menuPolevka.textContent = data.polevka || '-';
    menuJidlo1.textContent = data.jidlo1 || '-';
    menuJidlo2.textContent = data.jidlo2 || '-';
    menuDate.textContent = data.date || (new Date()).toLocaleDateString();
    menuBox.classList.remove('hidden');
    menuStatus.textContent = 'Jídelníček načten.';
  } catch (err) {
    menuStatus.textContent = 'Chyba při načítání menu: ' + err.message;
  }
}
loadMenu();

/* ========== UI logika pro typy a doručení ========== */
typSelect.addEventListener('change', () => {
  const t = typSelect.value;
  whichHalfLabel.classList.toggle('hidden', t !== 'Poloviční menu');
  // nastavit checky podle výběru (ale uživatel může upravit)
  if (t === 'Polévka') {
    chkPolevka.checked = true; chkJidlo1.checked = false; chkJidlo2.checked = false;
  } else if (t === 'Jídlo') {
    chkPolevka.checked = false;
  } else if (t === 'Půl + půl') {
    chkPolevka.checked = false; chkJidlo1.checked = true; chkJidlo2.checked = true;
  }
});

document.querySelectorAll('input[name="delivery"]').forEach(inp => {
  inp.addEventListener('change', () => {
    const v = document.querySelector('input[name="delivery"]:checked').value;
    if (v === 'Přivézt') {
      addressLabel.classList.remove('hidden');
      addressInput.required = true;
    } else {
      addressLabel.classList.add('hidden');
      addressInput.required = false;
    }
  });
});

/* ========== Validace objednávky před odesláním ========== */
function validateOrder(payload) {
  // základní validace
  if (!payload.name) return "Zadej jméno.";
  if (!payload.email) return "Zadej e-mail.";
  // typ
  const t = payload.typ;
  if (t === 'Polévka' && payload.polevka !== 'Ano') return "Pro 'Polévka' je potřeba zvolit polévku.";
  if (t === 'Jídlo' && payload.jidlo1 !== 'Ano' && payload.jidlo2 !== 'Ano') return "Pro 'Jídlo' zvol alespoň jedno hlavní jídlo.";
  if (t === 'Celé menu' && (payload.polevka !== 'Ano' || (payload.jidlo1 !== 'Ano' && payload.jidlo2 !== 'Ano' && payload.jidlo1 !== 'Ano'))) return "Pro 'Celé menu' zvol polévku a alespoň jedno hlavní jídlo.";
  if (t === 'Poloviční menu') {
    if (payload.polevka !== 'Ano') return "Poloviční menu vyžaduje polévku.";
    if (payload.whichHalf !== 'jidlo1' && payload.whichHalf !== 'jidlo2') return "U polovičního menu vyber, které hlavní půlku chceš.";
  }
  if (t === 'Půl + půl' && (payload.jidlo1 !== 'Ano' || payload.jidlo2 !== 'Ano')) return "Pro 'Půl + půl' musí být obě hlavní jídla zvolena.";
  if (payload.doruceni === 'Přivézt' && (!payload.adresa || payload.adresa.trim().length < 3)) return "Zadej platnou adresu pro doručení.";
  return null;
}

/* ========== Odeslání objednávky ========== */
orderForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  resultMsg.classList.add('hidden');
  btnSubmit.disabled = true;
  btnSubmit.textContent = 'Odesílám…';

  const payload = {
    name: nameInput.value.trim(),
    email: emailInput.value.trim(),
    polevka: chkPolevka.checked ? 'Ano' : 'Ne',
    jidlo1: chkJidlo1.checked ? 'Ano' : 'Ne',
    jidlo2: chkJidlo2.checked ? 'Ano' : 'Ne',
    typ: typSelect.value,
    whichHalf: whichHalf.value,
    doruceni: document.querySelector('input[name="delivery"]:checked').value,
    adresa: addressInput.value.trim()
  };

  const err = validateOrder(payload);
  if (err) {
    showResult(false, err);
    btnSubmit.disabled = false;
    btnSubmit.textContent = 'Odeslat objednávku';
    return;
  }

  try {
    const res = await fetch('https://script.google.com/macros/s/AKfycbxX8aAGEkt-uGzXnvWebktS7Qk_V-3EeLiN31e4ODwsTZmF1S2VpmEpE1sbzVP4OPso/exec', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error('Server vrátil chybu');
    const text = await res.text();
    // očekáváme "OK" nebo cokoliv jiného
    showResult(true, '✅ Objednávka byla odeslána. Děkujeme!');
    // volitelně vyčistit formulář nebo načíst menu znovu
    // orderForm.reset();
  } catch (err) {
    showResult(false, 'Chyba při odesílání: ' + err.message);
  } finally {
    btnSubmit.disabled = false;
    btnSubmit.textContent = 'Odeslat objednávku';
  }
});

function showResult(ok, text) {
  resultMsg.classList.remove('hidden');
  resultMsg.classList.remove('ok','err');
  resultMsg.classList.add(ok ? 'ok' : 'err');
  resultMsg.textContent = text;
}
</script>
</body>
</html>





